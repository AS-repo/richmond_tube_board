<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Richmond District Line – Live Departures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --color-background: #111111;
      --color-foreground: #FFFFFF;
      --color-primary: #33AADD; /* Blue for Titles/Highlight */
      --color-secondary: #FFCC00; /* Amber/Yellow for Countdown */
      --color-border: #444444; /* Lighter border */
      --font-sans: 'Arial', Helvetica, sans-serif;
    }

    body {
      font-family: var(--font-sans); 
      background-color: var(--color-background);
      color: var(--color-foreground);
      text-align: center;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 1.5rem;
      color: var(--color-primary);
      margin-bottom: 25px;
      text-transform: uppercase;
    }

    #board-container {
      width: 95%;
      max-width: 700px;
      background: #191919;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      overflow: hidden; 
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
      table-layout: fixed; 
    }

    /* Table Headers */
    th {
      color: var(--color-primary);
      background-color: #222222;
      border-bottom: 2px solid var(--color-primary);
      padding: 12px 10px;
      font-weight: bold; /* Use bold for serif headers */
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Table Cells */
    td {
      padding: 15px 10px;
      border-bottom: 1px solid var(--color-border);
      font-size: 1.1rem;
      text-align: center !important; /* FORCE CENTER ALIGNMENT FOR ALL DATA */
    }

    /* Last row has no bottom border */
    tr:last-child td {
        border-bottom: none;
    }

    td:nth-child(2) { /* Platform */
        width: 20%; /* Increased size slightly for better tap target */
    }

    td:nth-child(3) { /* Departs In */
        width: 30%; /* Gave "Departs In" more space */
    }

    td:nth-child(1) { /* Destination gets the remaining 50% */
        width: 50%;
    }
    
    .countdown {
      color: var(--color-secondary);
      font-weight: bold;
      font-size: 1.3rem;
    }

    footer {
      margin-top: 30px;
      font-size: 0.8rem;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Richmond District Line – Live Departures</h1>
  <div id="board-container">
    <table id="board">
      <tr><th>Platform</th><th>Departs In</th><th>Destination</th></tr>
    </table>
  </div>
  <footer>Live data from TfL • Updates every 10s</footer>
  <script>
    let trains = [];
    const RICHMOND_DISTRICT_ID = '940GZZLURMD';

    // get the platform number
    function getPlatformNumber(platformName) {
      const match = platformName.match(/(\d+)\s*$/);
      // Safely access the match result, defaults to 'N/A' if not found
      return match ? match[1] : 'N/A'; 
    }

    // A helper function to map destination
    function formatDestination(towards, timeToStation) {
        // If the API returns the train is 'At Platform' (timeToStation < 60) and 
        // the destination is empty or a placeholder (which happens at termini), 
        // assume the most common destination.
        if (timeToStation < 60 && towards === '') {
            return 'Upminster (predicted)'; 
        }
        return towards || 'N/A';
    }


    async function fetchData() {
      try {
        const res = await fetch(`https://api.tfl.gov.uk/StopPoint/${RICHMOND_DISTRICT_ID}/Arrivals`);
        const data = await res.json();

        trains = data
          .filter(t => t.lineName === "District")
          .sort((a, b) => a.timeToStation - b.timeToStation)
          .slice(0, 5)
          .map(t => ({
            destination: formatDestination(t.towards, t.timeToStation),
            platform: getPlatformNumber(t.platformName), 
            timeToStation: t.timeToStation 
          }));

      } catch (err) {
        console.error("Error fetching or processing data:", err);
        // display error message
      }
    }

    function updateCountdown() {
      const table = document.getElementById('board');
      // Set the header row once, then clear and re-add the data rows
      table.innerHTML = '<tr><th>Platform</th><th>Departs In</th><th>Destination</th></tr>';

      trains.forEach(t => {
        // Calculate minutes from seconds, rounded up
        const mins = Math.max(0, Math.ceil(t.timeToStation / 60));

        table.innerHTML += `<tr>
          <td>${t.platform}</td>
          <td class="countdown">${mins} min</td>
          <td>${t.destination}</td>
        </tr>`;
      });
    }

    // Initial fetch, then render
    fetchData().then(updateCountdown);

    // Refresh data from API every 10 seconds (this also updates the countdown)
    setInterval(fetchData, 10000); 

  </script>
</body>
</html>
