<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Richmond District Line – Live Departures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --color-background: #111111;
      --color-foreground: #FFFFFF;
      --color-primary: #33AADD; /* Blue for Titles/Highlight */
      --color-secondary: #FFCC00; /* Amber/Yellow for Countdown */
      --color-border: #444444; /* Lighter border */
      --font-sans: 'Arial', Helvetica, sans-serif;
    }

    body {
      font-family: var(--font-sans); 
      background-color: var(--color-background);
      color: var(--color-foreground);
      text-align: center;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 1.8rem;
      color: var(--color-primary);
      margin-bottom: 25px;
      text-transform: uppercase;
    }

    #board-container {
      width: 95%;
      max-width: 700px;
      background: #191919;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      overflow: hidden; 
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.2rem;
      table-layout: fixed; 
    }

    /* Table Headers */
    th {
      color: var(--color-primary);
      background-color: #222222;
      border-bottom: 2px solid var(--color-primary);
      padding: 12px 10px;
      font-weight: bold; /* Use bold for serif headers */
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Table Cells */
    td {
      padding: 15px 10px;
      border-bottom: 1px solid var(--color-border);
      font-size: 1.1rem;
      text-align: center !important; /* FORCE CENTER ALIGNMENT FOR ALL DATA */
    }

    /* Last row has no bottom border */
    tr:last-child td {
        border-bottom: none;
    }

    td:nth-child(2) { /* Platform */
        width: 20%; /* Increased size slightly for better tap target */
    }

    td:nth-child(3) { /* Departs In */
        width: 30%; /* Gave "Departs In" more space */
    }

    td:nth-child(1) { /* Destination gets the remaining 50% */
        width: 50%;
    }
    
    .countdown {
      color: var(--color-secondary);
      font-weight: bold;
      font-size: 1.3rem;
    }

    footer {
      margin-top: 30px;
      font-size: 0.8rem;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Richmond District Line – Live Departures</h1>
  <div id="board-container">
    <table id="board">
      <tr><th>Destination</th><th>Platform</th><th>Departs In</th></tr>
    </table>
  </div>
  <footer>Live data from TfL • Updates every 15s</footer>
  <script>
    let trains = [];
    const RICHMOND_DISTRICT_ID = '940GZZLURMD';

    // get the platform number
    function getPlatformNumber(platformName) {
      const match = platformName.match(/(\d+)\s*$/);
      return match ? match[1] : '?'; 
    }

    // A helper function to map destination
    function formatDestination(towards, timeToStation) {
        // Use more specific check for the 'towards' field
        const formattedTowards = (towards || '').toUpperCase().replace(/\s?UNDERGROUND STATION/g, '').trim();

        // If at terminal, and no explicit destination, assume Upminster (most common)
        if (timeToStation < 60 && !formattedTowards) {
            return 'UPMINSTER (predicted)'; 
        }
        
        return formattedTowards || 'N/A';
    }


    async function fetchData() {
      try {
        const res = await fetch(`https://api.tfl.gov.uk/StopPoint/${RICHMOND_DISTRICT_ID}/Arrivals`);
        const data = await res.json();

        // When new data arrives, overwrite the 'trains' array
        trains = data
          .filter(t => t.lineName === "District")
          .sort((a, b) => a.timeToStation - b.timeToStation)
          .slice(0, 5)
          .map(t => ({
            // Use destinationName first, fallback to towards
            destination: formatDestination(t.destinationName || t.towards, t.timeToStation),
            platform: getPlatformNumber(t.platformName), 
            timeToStation: t.timeToStation // Fresh time from API
          }));

      } catch (err) {
        console.error("Error fetching or processing data:", err);
      }
      updateCountdown();
    }

    function updateCountdown() {
      const table = document.getElementById('board');
      table.innerHTML = '<tr><th>Platform</th><th>Departs In</th><th>Destination</th></tr>';

      trains.forEach(t => {
        let timeDisplay;
        const seconds = t.timeToStation;

        if (seconds <= 5) {
            // Treat 5 seconds or less as departed/imminent for better visual feedback
            timeDisplay = "DUE";
        } else if (seconds <= 60) {
            // For the final minute, always show "1 min"
            timeDisplay = "1 min";
        } else {
            // For all other times, use Math.floor (round down) for accuracy
            const mins = Math.floor(seconds / 60);
            timeDisplay = `${mins} min`;
        }
        
        // Redraw the row
        table.innerHTML += `<tr>
          <td>${t.platform}</td>
          <td class="countdown">${timeDisplay}</td>
          <td>${t.destination}</td>
        </tr>`;
      });
    }

    fetchData();
    setInterval(fetchData, 10000); 
  </script>
</body>
</html>
