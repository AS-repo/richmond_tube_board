<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Richmond District Line – Live Departures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --color-background: #111111;
      --color-foreground: #FFFFFF;
      --color-primary: #33AADD; /* Blue for Titles/Highlight */
      --color-secondary: #FFCC00; /* Amber/Yellow for Countdown */
      --color-border: #444444; /* Lighter border */
      --font-sans: 'Arial', Helvetica, sans-serif;
    }

    body {
      font-family: var(--font-sans); 
      background-color: var(--color-background);
      color: var(--color-foreground);
      text-align: center;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 1.5rem;
      color: var(--color-primary);
      margin-bottom: 25px;
      text-transform: uppercase;
    }

    #board-container {
      width: 95%;
      max-width: 500px; /* Reduced max width for the 2-column layout */
      background: #191919;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      overflow: hidden; 
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
      table-layout: fixed; 
    }

    /* Table Headers */
    th {
      color: var(--color-primary);
      background-color: #222222;
      border-bottom: 2px solid var(--color-primary);
      padding: 12px 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Table Cells */
    td {
      padding: 15px 10px;
      border-bottom: 1px solid var(--color-border);
      font-size: 1.1rem;
      text-align: center !important; /* FORCE CENTER ALIGNMENT FOR ALL DATA */
    }

    /* Last row has no bottom border */
    tr:last-child td {
        border-bottom: none;
    }

    /* --- COLUMN WIDTH FIX: Set Platform (1) and Departs In (2) to 50% each --- */
    td:nth-child(1) { /* Platform */
        width: 50%;
    }

    td:nth-child(2) { /* Departs In */
        width: 50%;
    }

    /* Removed old td:nth-child(3) width rule */
    
    .countdown {
      color: var(--color-secondary);
      font-weight: bold;
      font-size: 1.3rem;
    }

    footer {
      margin-top: 30px;
      font-size: 0.8rem;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Richmond District Line – Live Departures</h1>
  <div id="board-container">
    <table id="board">
      <!-- REMOVED DESTINATION HEADER -->
      <tr><th>Platform</th><th>Departs In</th></tr>
    </table>
  </div>
  <footer>Live data from TfL • Updates every 10s</footer>
  <script>
    let trains = [];
    const RICHMOND_DISTRICT_ID = '940GZZLURMD';

    // get the platform number
    function getPlatformNumber(platformName) {
      const match = platformName.match(/(\d+)\s*$/);
      // Safely access the match result, defaults to 'N/A' if not found
      return match ? match[1] : 'N/A'; 
    }

    // A helper function to map destination (kept for data filtering/mapping but unused in display)
    function formatDestination(towards, timeToStation) {
        const formattedTowards = (towards || '').toUpperCase().replace(/\s?UNDERGROUND STATION/g, '').trim();

        if (timeToStation < 60 && !formattedTowards) {
            return 'Upminster (predicted)'; 
        }
        return formattedTowards || 'N/A';
    }


    async function fetchData() {
      try {
        const res = await fetch(`https://api.tfl.gov.uk/StopPoint/${RICHMOND_DISTRICT_ID}/Arrivals`);
        const data = await res.json();

        trains = data
          .filter(t => t.lineName === "District")
          .sort((a, b) => a.timeToStation - b.timeToStation)
          .slice(0, 5)
          .map(t => ({
            destination: formatDestination(t.towards, t.timeToStation),
            platform: getPlatformNumber(t.platformName), 
            timeToStation: t.timeToStation 
          }));

      } catch (err) {
        console.error("Error fetching or processing data:", err);
        // display error message
      }
      // Critical: Call updateCountdown immediately after fetching new data
      updateCountdown(); 
    }

    function updateCountdown() {
      const table = document.getElementById('board');
      // FIX 1: Set the header row to 2 columns
      table.innerHTML = '<tr><th>Platform</th><th>Departs In</th></tr>';

      trains.forEach(t => {
        let timeDisplay;
        const seconds = t.timeToStation;

        // FIX 2: Implement "DUE" for less than 1 minute (60 seconds)
        if (seconds <= 60) {
             timeDisplay = "DUE";
        } else {
             // For all times over 1 minute, use Math.floor (round down)
             const mins = Math.floor(seconds / 60);
             timeDisplay = `${mins} min`;
        }

        // FIX 3: Remove Destination data cell (Platform | Departs In)
        table.innerHTML += `<tr>
          <td>${t.platform}</td>
          <td class="countdown">${timeDisplay}</td>
        </tr>`;
      });
    }

    // Initial fetch to populate the board
    // Removed .then() since fetchData calls updateCountdown() directly
    fetchData();

    // Refresh data from API every 10 seconds (this also updates the countdown)
    setInterval(fetchData, 10000); 

  </script>
</body>
</html>
