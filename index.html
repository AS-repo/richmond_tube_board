<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Richmond District Line – Live Departures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --color-background: #111111;
      --color-foreground: #FFFFFF;
      --color-primary: #33AADD; /* Blue for Titles/Highlight */
      --color-secondary: #FFCC00; /* Amber/Yellow for Countdown */
      --color-border: #444444; /* Lighter border */
      --font-serif: 'Georgia', 'Times New Roman', serif; /* Serif font */
    }

    body {
      font-family: var(--font-serif); 
      background-color: var(--color-background);
      color: var(--color-foreground);
      text-align: center;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-size: 1.8rem;
      color: var(--color-primary);
      margin-bottom: 25px;
      text-transform: uppercase;
    }

    #board-container {
      width: 95%;
      max-width: 700px;
      background: #191919;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      overflow: hidden; 
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.2rem;
      table-layout: fixed; 
    }

    /* Table Headers */
    th {
      color: var(--color-primary);
      background-color: #222222;
      border-bottom: 2px solid var(--color-primary);
      padding: 12px 10px;
      font-weight: bold; /* Use bold for serif headers */
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Table Cells */
    td {
      padding: 15px 10px;
      border-bottom: 1px solid var(--color-border);
      font-size: 1.1rem;
      text-align: center !important; /* FORCE CENTER ALIGNMENT FOR ALL DATA */
    }

    /* Last row has no bottom border */
    tr:last-child td {
        border-bottom: none;
    }

    /* Column Sizing - alignment handled by the generic td style */
    td:nth-child(2) { /* Platform */
        width: 15%;
    }

    td:nth-child(3) { /* Departs In */
        width: 25%;
    }
    
    .countdown {
      color: var(--color-secondary);
      font-weight: bold;
      font-size: 1.3rem;
    }

    footer {
      margin-top: 30px;
      font-size: 0.8rem;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Richmond District Line – Live Departures</h1>
  <div id="board-container">
    <table id="board">
      <tr><th>Destination</th><th>Platform</th><th>Departs In</th></tr>
    </table>
  </div>
  <footer>Live data from TfL • Updates every 15s</footer>
  <script>
    let trains = [];
    const RICHMOND_DISTRICT_ID = '940GZZLURMD';

    // get the platform number
    function getPlatformNumber(platformName) {
      const match = platformName.match(/(\d+)\s*$/);
      return match ? match[1] : '?'; 
    }

    // A helper function to map destination
    function formatDestination(towards, timeToStation) {
        // Use more specific check for the 'towards' field
        const formattedTowards = (towards || '').toUpperCase().replace(/\s?UNDERGROUND STATION/g, '').trim();

        // If at terminal, and no explicit destination, assume Upminster (most common)
        if (timeToStation < 60 && !formattedTowards) {
            return 'UPMINSTER (predicted)'; 
        }
        
        return formattedTowards || 'N/A';
    }


    async function fetchData() {
      try {
        const res = await fetch(`https://api.tfl.gov.uk/StopPoint/${RICHMOND_DISTRICT_ID}/Arrivals`);
        const data = await res.json();

        trains = data
          .filter(t => t.lineName === "District")
          .sort((a, b) => a.timeToStation - b.timeToStation)
          .slice(0, 5)
          .map(t => ({
            // Use destinationName first, fallback to towards
            destination: formatDestination(t.destinationName || t.towards, t.timeToStation),
            platform: getPlatformNumber(t.platformName), 
            timeToStation: t.timeToStation // Fresh time from API
          }));

      } catch (err) {
        console.error("Error fetching or processing data:", err);
      }
      // CRITICAL: Call updateCountdown immediately after fetching new data
      updateCountdown();
    }

    function updateCountdown() {
      const table = document.getElementById('board');
      // Set the header row once, then clear and re-add the data rows
      table.innerHTML = '<tr><th>Destination</th><th>Platform</th><th>Departs In</th></tr>';

      trains.forEach(t => {
        // 1. Decrement the time by 1 second for the next display tick (smooth countdown)
        t.timeToStation = Math.max(0, t.timeToStation - 1); 

        let timeDisplay;
        const seconds = t.timeToStation;

        if (seconds <= 0) {
            timeDisplay = "DEPARTED";
        } else if (seconds <= 60) {
            // FIX: For the last minute, display "1 min" (0-60 seconds)
            timeDisplay = "1 min";
        } else {
            // FIX: For all times over 60 seconds, use Math.floor (round down)
            // This prevents 121 seconds from incorrectly showing as "3 min"
            const mins = Math.floor(seconds / 60);
            timeDisplay = `${mins} min`;
        }
        
        // Redraw the row
        table.innerHTML += `<tr>
          <td>${t.destination}</td>
          <td>${t.platform}</td>
          <td class="countdown">${timeDisplay}</td>
        </tr>`;
      });
    }

    // 1. Initial fetch to populate the board
    fetchData();

    // 2. Fast Timer: Runs every second to decrement the time and redraw the board (smooth countdown).
    setInterval(updateCountdown, 1000);

    // 3. Slow Timer: Refreshes data from API every 10 seconds (for accuracy and new trains).
    setInterval(fetchData, 10000); 

</script>
</body>
</html>
